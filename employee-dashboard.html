<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة الموظف</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* محتوى CSS كما هو */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
            transition: background 0.3s ease;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
        }
        .employee-container {
            max-width: 1000px;
            margin: 30px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .employee-container {
            background: #1e1e2f;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        .header {
            background: linear-gradient(120deg, #28a745, #218838);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode .header {
            background: linear-gradient(120deg, #1e7e34, #1a6a2c);
        }
        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #28a745;
            font-size: 1.5rem;
            font-weight: bold;
        }
        body.dark-mode .avatar {
            background: #2d2d42;
            color: #4caf50;
        }
        .user-details {
            text-align: right;
        }
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .user-role {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 25px;
        }
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        section {
            background: #f9fbfd;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #eaeff5;
            transition: background 0.3s ease;
        }
        body.dark-mode section {
            background: #2d2d42;
            border-color: #444;
        }
        h2 {
            color: #28a745;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeff5;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        body.dark-mode h2 {
            color: #4caf50;
            border-bottom-color: #444;
        }
        h2 i {
            font-size: 1.3rem;
        }
        .profile-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .profile-card {
            background: #3d3d5c;
            color: #e6e6e6;
        }
        .profile-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f4f8;
        }
        body.dark-mode .profile-item {
            border-bottom-color: #444;
        }
        .profile-label {
            font-weight: 600;
            width: 120px;
            color: #555;
        }
        body.dark-mode .profile-label {
            color: #bbb;
        }
        .profile-value {
            flex: 1;
            color: #333;
        }
        body.dark-mode .profile-value {
            color: #e6e6e6;
        }
        .attendance-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .attendance-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .check-in-btn {
            background: linear-gradient(120deg, #007bff, #0056b3);
        }
        .check-out-btn {
            background: linear-gradient(120deg, #dc3545, #c82333);
        }
        .attendance-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .attendance-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status-container {
            background: #e8f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        body.dark-mode .status-container {
            background: #1a237e;
        }
        .attendance-list {
            margin-top: 20px;
        }
        .attendance-list h3 {
            margin-bottom: 15px;
            color: #28a745;
        }
        body.dark-mode .attendance-list h3 {
            color: #4caf50;
        }
        .attendance-item {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .attendance-item {
            background: #3d3d5c;
        }
        .attendance-date {
            font-weight: 600;
        }
        .attendance-times {
            display: flex;
            gap: 15px;
        }
        .time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .time-label {
            font-size: 0.8rem;
            color: #777;
        }
        body.dark-mode .time-label {
            color: #aaa;
        }
        .time-value {
            font-weight: 600;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-present {
            background: #d4edda;
            color: #155724;
        }
        .status-absent {
            background: #f8d7da;
            color: #721c24;
        }
        body.dark-mode .status-present {
            background: #2e7d32;
            color: #e8f5e9;
        }
        body.dark-mode .status-absent {
            background: #c62828;
            color: #ffebee;
        }
        .leave-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-weight: 600;
            color: #555;
        }
        body.dark-mode .form-group label {
            color: #bbb;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #333;
        }
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #3d3d5c;
            border-color: #444;
            color: #e6e6e6;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .submit-btn {
            background: linear-gradient(120deg, #28a745, #218838);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        .salary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .salary-card {
            background: #3d3d5c;
        }
        .salary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f4f8;
        }
        body.dark-mode .salary-item {
            border-bottom-color: #444;
        }
        .salary-label {
            color: #555;
        }
        body.dark-mode .salary-label {
            color: #bbb;
        }
        .salary-value {
            font-weight: 600;
            color: #333;
        }
        body.dark-mode .salary-value {
            color: #e6e6e6;
        }
        .total-salary {
            font-weight: 700;
            font-size: 1.2rem;
            color: #28a745;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #eaeff5;
        }
        body.dark-mode .total-salary {
            color: #4caf50;
            border-top-color: #444;
        }
        .leave-requests {
            margin-top: 20px;
        }
        .leave-requests h3 {
            margin-bottom: 15px;
            color: #28a745;
        }
        body.dark-mode .leave-requests h3 {
            color: #4caf50;
        }
        .leave-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .leave-item {
            background: #3d3d5c;
        }
        .leave-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .leave-dates {
            font-weight: 600;
        }
        .leave-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        body.dark-mode .status-pending {
            background: #ffc107;
            color: #333;
        }
        body.dark-mode .status-approved {
            background: #2e7d32;
            color: #e8f5e9;
        }
        body.dark-mode .status-rejected {
            background: #c62828;
            color: #ffebee;
        }
        .leave-details {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.9rem;
        }
        body.dark-mode .leave-details {
            color: #aaa;
        }
        .logout-btn {
            background: linear-gradient(120deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        body.dark-mode .message.error {
            background-color: #c62828;
            color: #ffebee;
            border-color: #d32f2f;
        }
        body.dark-mode .message.success {
            background-color: #2e7d32;
            color: #e8f5e9;
            border-color: #388e3c;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        body.dark-mode .loading {
            color: #aaa;
        }
        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #28a745;
        }
        body.dark-mode .loading i {
            color: #4caf50;
        }
        .today-attendance {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
        }
        body.dark-mode .today-attendance {
            background: #1a237e;
        }
        .time-display {
            text-align: center;
        }
        .time-value-large {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007bff;
        }
        body.dark-mode .time-value-large {
            color: #64b5f6;
        }
        .time-label-large {
            font-size: 0.9rem;
            color: #666;
        }
        body.dark-mode .time-label-large {
            color: #aaa;
        }
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        body.dark-mode .connection-status {
            background: #2e7d32;
            color: #e8f5e9;
        }
        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        body.dark-mode .connection-status.error {
            background: #c62828;
            color: #ffebee;
        }
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body.dark-mode .theme-toggle {
            background: #4caf50;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background: #dc3545;
        }
        .notification.success {
            background: #28a745;
        }
        .attendance-calendar {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        body.dark-mode .attendance-calendar {
            background: #3d3d5c;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            text-align: center;
            padding: 8px 0;
            font-weight: 600;
            color: #28a745;
        }
        body.dark-mode .calendar-day {
            color: #4caf50;
        }
        .calendar-date {
            background: #f0f4f8;
            border-radius: 50%;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        body.dark-mode .calendar-date {
            background: #3d3d5c;
        }
        .calendar-date:hover {
            background: #28a745;
            color: white;
        }
        .calendar-date.present {
            background: #d4edda;
            color: #155724;
        }
        body.dark-mode .calendar-date.present {
            background: #2e7d32;
            color: #e8f5e9;
        }
        .calendar-date.absent {
            background: #f8d7da;
            color: #721c24;
        }
        body.dark-mode .calendar-date.absent {
            background: #c62828;
            color: #ffebee;
        }
        .calendar-date.today {
            border: 2px solid #28a745;
        }
        body.dark-mode .calendar-date.today {
            border-color: #4caf50;
        }
        .attendance-details {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
        }
        body.dark-mode .attendance-details {
            background: #1a237e;
        }
        .attendance-details h4 {
            margin-bottom: 10px;
            color: #28a745;
        }
        body.dark-mode .attendance-details h4 {
            color: #4caf50;
        }
        .stats-container {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
        }
        body.dark-mode .stat-value {
            color: #4caf50;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        body.dark-mode .stat-label {
            color: #aaa;
        }
    </style>
</head>
<body dir="rtl">
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </button>
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-plug"></i> الاتصال بـ Supabase: جاري الاتصال...
    </div>
    <div class="notification" id="notification">
        <i class="fas fa-bell"></i>
        <span id="notificationText">تم تسجيل الحضور بنجاح</span>
    </div>
    <div class="employee-container">
        <div class="header">
            <h1><i class="fas fa-user-tie"></i> بوابة الموظف</h1>
            <div class="user-info">
                <div class="avatar" id="userAvatar">م</div>
                <div class="user-details">
                    <div class="user-name" id="userName">جاري التحميل...</div>
                    <div class="user-role" id="userRole">جاري التحميل...</div>
                </div>
            </div>
        </div>
        <div class="main-content">
            <section id="profileSection">
                <h2><i class="fas fa-id-card"></i> الملف الشخصي</h2>
                <div class="profile-card" id="profileDetails">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>جاري تحميل البيانات...</p>
                    </div>
                </div>
            </section>
            <section id="attendanceSection">
                <h2><i class="fas fa-clock"></i> الحضور والانصراف</h2>
                <div class="attendance-buttons">
                    <button id="checkInBtn" class="attendance-btn check-in-btn" disabled>
                        <i class="fas fa-sign-in-alt"></i> تسجيل الحضور
                    </button>
                    <button id="checkOutBtn" class="attendance-btn check-out-btn" disabled>
                        <i class="fas fa-sign-out-alt"></i> تسجيل الانصراف
                    </button>
                </div>
                <div class="today-attendance">
                    <div class="time-display">
                        <div class="time-value-large" id="checkInTime">-</div>
                        <div class="time-label-large">وقت الحضور</div>
                    </div>
                    <div class="time-display">
                        <div class="time-value-large" id="checkOutTime">-</div>
                        <div class="time-label-large">وقت الانصراف</div>
                    </div>
                </div>
                <div id="attendanceStatus"></div>
                <div class="attendance-calendar">
                    <div class="calendar-header">
                        <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonth">يناير 2024</h3>
                        <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day">أحد</div>
                        <div class="calendar-day">اثنين</div>
                        <div class="calendar-day">ثلاثاء</div>
                        <div class="calendar-day">أربعاء</div>
                        <div class="calendar-day">خميس</div>
                        <div class="calendar-day">جمعة</div>
                        <div class="calendar-day">سبت</div>
                    </div>
                    <div id="calendarDates" class="calendar-grid"></div>
                </div>
                <div class="attendance-details">
                    <h4><i class="fas fa-info-circle"></i> تفاصيل الحضور لهذا الشهر</h4>
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-value" id="presentDays">0</div>
                            <div class="stat-label">أيام حضور</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="absentDays">0</div>
                            <div class="stat-label">أيام غياب</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="lateDays">0</div>
                            <div class="stat-label">أيام تأخير</div>
                        </div>
                    </div>
                </div>
                <div class="attendance-list">
                    <h3><i class="fas fa-history"></i> سجل الحضور</h3>
                    <div id="attendanceList">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>جاري تحميل سجل الحضور...</p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="leaveSection">
                <h2><i class="fas fa-calendar-alt"></i> طلب إجازة</h2>
                <form id="leaveForm" class="leave-form">
                    <div class="form-group">
                        <label for="leaveStart"><i class="fas fa-calendar-day"></i> تاريخ البدء:</label>
                        <input type="date" id="leaveStart" required>
                    </div>
                    <div class="form-group">
                        <label for="leaveEnd"><i class="fas fa-calendar-day"></i> تاريخ الانتهاء:</label>
                        <input type="date" id="leaveEnd" required>
                    </div>
                    <div class="form-group">
                        <label for="leaveType"><i class="fas fa-file-alt"></i> نوع الإجازة:</label>
                        <select id="leaveType" required>
                            <option value="annual">سنوية</option>
                            <option value="sick">مرضية</option>
                            <option value="emergency">طارئة</option>
                            <option value="unpaid">بدون راتب</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="leaveReason"><i class="fas fa-comment"></i> السبب:</label>
                        <textarea id="leaveReason" placeholder="اكتب سبب الإجازة هنا..."></textarea>
                    </div>
                    <button type="submit" class="submit-btn" id="submitLeaveBtn" disabled>
                        <i class="fas fa-paper-plane"></i> إرسال الطلب
                    </button>
                </form>
                <div class="leave-requests">
                    <h3><i class="fas fa-list"></i> طلبات الإجازة</h3>
                    <div id="leaveRequests">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>جاري تحميل طلبات الإجازة...</p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="salarySection">
                <h2><i class="fas fa-money-bill-wave"></i> الراتب الشهري</h2>
                <div class="salary-card">
                    <div class="salary-item">
                        <div class="salary-label">نوع الشيفت:</div>
                        <div class="salary-value" id="shiftType">8 ساعات</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">معدل الساعة:</div>
                        <div class="salary-value" id="hourlyRate">0 ج.م</div>
                    </div>
                </div>
                <div class="salary-card" id="salaryInfo" style="margin-top: 15px;">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>جاري تحميل معلومات الراتب...</p>
                    </div>
                </div>
                <div class="salary-card" id="expectedSalary" style="margin-top: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;"><i class="fas fa-calculator"></i> توقع الراتب للشهر الحالي</h3>
                    <div class="salary-item">
                        <div class="salary-label">أيام الحضور:</div>
                        <div class="salary-value" id="workDaysCount">0</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">التأخير المتراكم:</div>
                        <div class="salary-value" id="lateMinutesCount" style="color: #dc3545;">0 دقيقة</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">خصم متوقع للتأخير:</div>
                        <div class="salary-value" id="expectedLateDeduction" style="color: #dc3545;">0 ج.م</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">الإضافي المتراكم:</div>
                        <div class="salary-value" id="overtimeMinutesCount" style="color: #28a745;">0 دقيقة</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">مكافأة متوقعة للإضافي:</div>
                        <div class="salary-value" id="expectedOvertimeBonus" style="color: #28a745;">0 ج.م</div>
                    </div>
                    <div class="salary-item total-salary">
                        <div class="salary-label">الراتب المتوقع:</div>
                        <div class="salary-value" id="expectedTotalSalary">0 ج.م</div>
                    </div>
                </div>
            </section>
        </div>
        <button class="logout-btn" onclick="handleSignOut()">
            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
    </div>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        const supabaseUrl = "https://nxhnivykhlnauewpmuqv.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54aG5pdnlraGxuYXVld3BtdXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4Mjk2NTYsImV4cCI6MjA3NDQwNTY1Nn0.-3ps3Mp7aYuA2m54sW3gNN3CpZ2acRtKGj8jI5eHTOU";
        const supabase = createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let currentMonth = new Date();
        // Dark mode toggle
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const icon = themeToggle.querySelector('i');
            if (body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });
        // Apply saved theme
        if (localStorage.getItem('theme') === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.querySelector('i').classList.remove('fa-moon');
            themeToggle.querySelector('i').classList.add('fa-sun');
        }
        // Show notification
        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        // تحديث حالة الاتصال
        document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-check-circle"></i> متصل بـ Supabase';
        document.getElementById('connectionStatus').classList.remove('error');
        // التحقق من الجلسة
        async function checkSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error || !session) {
                    document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> خطأ في الجلسة';
                    document.getElementById('connectionStatus').classList.add('error');
                    window.location.href = 'index.html';
                    return null;
                }
                currentUser = session.user;
                return session;
            } catch (error) {
                console.error("Error checking session:", error);
                window.location.href = 'index.html';
                return null;
            }
        }
        // جلب بيانات المستخدم من جدول users
        async function fetchUserProfile(userId) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                if (error) throw error;
                return data;
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return null;
            }
        }
        // جلب الراتب من جدول salaries
        async function fetchSalary(userId) {
            try {
                const { data, error } = await supabase
                    .from('salaries')
                    .select('*')
                    .eq('user_id', userId)
                    .order('month', { ascending: false })
                    .limit(1);
                if (error) throw error;
                return data && data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error("Error fetching salary:", error);
                return null;
            }
        }
        // جلب سجل الحضور من جدول attendance
        async function fetchAttendance(userId) {
            try {
                const { data, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('user_id', userId)
                    .order('date', { ascending: false })
                    .limit(10);
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error("Error fetching attendance:", error);
                return [];
            }
        }
        // جلب سجل الحضور لهذا الشهر
        async function fetchAttendanceForMonth(userId, year, month) {
            try {
                const { data, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('user_id', userId)
                    .gte('date', `${year}-${String(month).padStart(2, '0')}-01`)
                    .lt('date', `${year}-${String(month + 1).padStart(2, '0')}-01`);
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error("Error fetching attendance for month:", error);
                return [];
            }
        }
// موقع الشركة (الإحداثيات الجديدة)
const companyLocation = {
  lat: 30.4763889,  // 30°28'35.0"N → 30.4763889
  lng: 31.1798333   // 31°10'47.4"E → 31.1798333
};

// نصف قطر مسموح (مثلاً 200 متر حوالين الشركة)
const allowedRadius = 200;
// دالة لحساب المسافة بين نقطتين (Haversine Formula)
function getDistanceInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // نصف قطر الأرض بالمتر
    const toRad = (deg) => (deg * Math.PI) / 180;

    const φ1 = toRad(lat1);
    const φ2 = toRad(lat2);
    const Δφ = toRad(lat2 - lat1);
    const Δλ = toRad(lon2 - lon1);

    const a =
        Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c; // المسافة بالمتر
}

async function getUserLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("المتصفح لا يدعم تحديد الموقع"));
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        resolve({
          lat: position.coords.latitude,
          lng: position.coords.longitude
        });
      },
      (error) => {
        reject(new Error("فشل الحصول على الموقع: " + error.message));
      }
    );
  });
}


async function recordCheckIn() {
  try {
    // جلب الموقع
    const location = await getUserLocation();

    // حساب المسافة
    const distance = getDistanceInMeters(
      location.lat, location.lng,
      companyLocation.lat, companyLocation.lng
    );

    // تحقق إن الموظف داخل النطاق
    if (distance > allowedRadius) {
      showNotification('أنت خارج نطاق الشركة! (المسافة: ' + Math.round(distance) + ' م)', 'error');
      return;
    }

    // --------- هنا التسجيل في attendance ----------
    const today = new Date().toISOString().split('T')[0];
    const time = new Date().toTimeString().split(' ')[0].substring(0, 5);

    const existingRecord = await fetchAttendanceForDate(currentUser.id, today);
    if (existingRecord && existingRecord.check_in) {
      showNotification('لقد قمت بالفعل بتسجيل الحضور اليوم.', 'error');
      document.getElementById('checkInBtn').disabled = true;
      return;
    }

const { error } = await supabase
  .from('attendance')
  .insert([{
    user_id: currentUser.id,
    date: today,
    check_in: time,
    status: 'present',
    check_in_lat: location.lat,
    check_in_lng: location.lng
  }]);

    if (error) throw error;

    showNotification(`تم تسجيل الحضور بنجاح الساعة ${time}`, 'success');
    document.getElementById('checkInBtn').disabled = true;
    document.getElementById('checkInTime').textContent = time;
    loadAttendanceList();
    loadAttendanceCalendar();
    calculateExpectedSalary(); // تحديث توقع الراتب

  } catch (error) {
    console.error("Error recording check-in:", error);
    showNotification('فشل تسجيل الحضور: ' + error.message, 'error');
  }
}

async function recordCheckOut() {
  try {
    // جلب الموقع
    const location = await getUserLocation();

    // حساب المسافة
    const distance = getDistanceInMeters(
      location.lat, location.lng,
      companyLocation.lat, companyLocation.lng
    );

    if (distance > allowedRadius) {
      showNotification('لا يمكنك تسجيل الانصراف من خارج الشركة! (المسافة: ' + Math.round(distance) + ' م)', 'error');
      return;
    }

    // --------- هنا تحديث attendance ----------
    const today = new Date().toISOString().split('T')[0];
    const time = new Date().toTimeString().split(' ')[0].substring(0, 5);

    const existingRecord = await fetchAttendanceForDate(currentUser.id, today);
    if (existingRecord && existingRecord.check_out) {
      showNotification('لقد قمت بالفعل بتسجيل الانصراف اليوم.', 'error');
      document.getElementById('checkOutBtn').disabled = true;
      return;
    }
    if (!existingRecord || !existingRecord.check_in) {
      showNotification('يجب تسجيل الحضور أولاً قبل تسجيل الانصراف.', 'error');
      return;
    }

const { error } = await supabase
  .from('attendance')
  .update({
    check_out: time,
    check_out_lat: location.lat,
    check_out_lng: location.lng
  })
  .eq('id', existingRecord.id);

    if (error) throw error;

    showNotification(`تم تسجيل الانصراف بنجاح الساعة ${time}`, 'success');
    document.getElementById('checkOutBtn').disabled = true;
    document.getElementById('checkOutTime').textContent = time;
    loadAttendanceList();
    loadAttendanceCalendar();
    calculateExpectedSalary();

  } catch (error) {
    console.error("Error recording check-out:", error);
    showNotification('فشل تسجيل الانصراف: ' + error.message, 'error');
  }
}



        // حساب الراتب المتوقع للشهر الحالي
        async function calculateExpectedSalary() {
            try {
                const profile = await fetchUserProfile(currentUser.id);
                if (!profile) return;
                const currentMonth = new Date().toISOString().substring(0, 7);
                const year = new Date().getFullYear();
                const month = new Date().getMonth() + 1;
                const daysInMonth = new Date(year, month, 0).getDate();

                // جلب حضور الشهر الحالي
                const {  attendance, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('date', `${currentMonth}-01`)
                    .lte('date', `${currentMonth}-${daysInMonth}`);
                if (error) throw error;

                const baseSalary = profile.basic_salary || 0;
                const shiftHours = profile.shift_type || 8; // افتراض 8 ساعات شفت
                const hourlyRate = profile.hourly_rate || (baseSalary / (daysInMonth * shiftHours)); // حساب معدل الساعة إذا لم يكن محددًا

                let workDays = attendance?.length || 0;
                let totalLateMinutes = 0;
                let totalOvertimeMinutes = 0;

                // حساب التأخير والإضافي
                attendance?.forEach(record => {
                    if (record.check_in) {
                        const checkInTime = new Date(`1970-01-01T${record.check_in}`);
                        const standardTime = new Date('1970-01-01T09:00:00'); // افتراض وقت الحضور القياسي 9:00 ص
                        const lateMins = (checkInTime - standardTime) / (1000 * 60);
                        if (lateMins > 0) {
                            totalLateMinutes += lateMins;
                        }
                    }
                    if (record.check_in && record.check_out) {
                        const inTime = new Date(`1970-01-01T${record.check_in}`);
                        const outTime = new Date(`1970-01-01T${record.check_out}`);
                        const actualHours = (outTime - inTime) / (1000 * 60 * 60);
                        if (actualHours > shiftHours) {
                            totalOvertimeMinutes += (actualHours - shiftHours) * 60;
                        }
                    }
                    // جمع التأخير والعمل الإضافي من الحقول المخزنة في قاعدة البيانات إن وجدت
                    totalLateMinutes += record.late_minutes || 0;
                    totalOvertimeMinutes += record.overtime_minutes || 0;
                });

                const lateDeduction = (totalLateMinutes / 60) * hourlyRate;
                const overtimeBonus = (totalOvertimeMinutes / 60) * hourlyRate;
                const expectedSalary = (workDays * shiftHours * hourlyRate) - lateDeduction + overtimeBonus;

                document.getElementById('workDaysCount').textContent = workDays;
                document.getElementById('lateMinutesCount').textContent = `${Math.round(totalLateMinutes)} دقيقة`;
                document.getElementById('expectedLateDeduction').textContent = `${lateDeduction.toFixed(2)} ج.م`;
                document.getElementById('overtimeMinutesCount').textContent = `${Math.round(totalOvertimeMinutes)} دقيقة`;
                document.getElementById('expectedOvertimeBonus').textContent = `${overtimeBonus.toFixed(2)} ج.م`;
                document.getElementById('expectedTotalSalary').textContent = `${expectedSalary.toFixed(2)} ج.م`;

                // تحديث عرض معلومات الشيفت والمعدل الساعة
                document.getElementById('shiftType').textContent = `${shiftHours} ساعات`;
                document.getElementById('hourlyRate').textContent = `${hourlyRate.toFixed(2)} ج.م`;

            } catch (error) {
                console.error("Error calculating expected salary:", error);
                // من الأفضل عرض رسالة خطأ في UI بدلاً من السكوت
                document.getElementById('expectedTotalSalary').textContent = "خطأ في الحساب";
                document.getElementById('workDaysCount').textContent = "0";
                document.getElementById('lateMinutesCount').textContent = "0 دقيقة";
                document.getElementById('expectedLateDeduction').textContent = "0 ج.م";
                document.getElementById('overtimeMinutesCount').textContent = "0 دقيقة";
                document.getElementById('expectedOvertimeBonus').textContent = "0 ج.م";
            }
        }

        // جلب طلبات الإجازة من جدول leaves
        async function fetchLeaves(userId) {
            try {
                const { data, error } = await supabase
                    .from('leaves')
                    .select('*')
                    .eq('user_id', userId)
                    .order('start_date', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error("Error fetching leaves:", error);
                return [];
            }
        }
        // جلب سجل الحضور لتاريخ محدد
        async function fetchAttendanceForDate(userId, date) {
            try {
                const { data, error } = await supabase
                    .from('attendance')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('date', date)
                    .single();
                if (error && error.code !== 'PGRST116') throw error; // PGRST116 يعني لا يوجد سجل
                return data;
            } catch (error) {
                console.error("Error fetching attendance for date:", error);
                return null;
            }
        }
        // تقديم طلب إجازة
        async function submitLeaveRequest(leaveData) {
            try {
                // بناء كائن الإدخال بشكل ديناميكي
                const insertData = {
                    user_id: currentUser.id,
                    start_date: leaveData.start_date,
                    end_date: leaveData.end_date,
                    type: leaveData.type,
                    status: 'pending'
                };
                // إضافة الحقل 'reason' فقط إذا كان موجودًا في النموذج
                if (leaveData.reason) {
                    insertData.reason = leaveData.reason;
                }
                const { error } = await supabase
                    .from('leaves')
                    .insert([insertData]);
                if (error) throw error;
                showNotification('تم إرسال طلب الإجازة بنجاح', 'success');
                document.getElementById('leaveForm').reset();
                loadLeaveRequests();
            } catch (error) {
                console.error("Error submitting leave request:", error);
                showNotification('فشل إرسال طلب الإجازة: ' + error.message, 'error');
            }
        }
        // تحميل الملف الشخصي
        async function loadUserProfile() {
            const profile = await fetchUserProfile(currentUser.id);
            const detailsDiv = document.getElementById('profileDetails');
            if (profile) {
                const firstName = profile.full_name ? profile.full_name.charAt(0) : 'م';
                document.getElementById('userAvatar').textContent = firstName;
                document.getElementById('userName').textContent = profile.full_name || 'موظف';
                document.getElementById('userRole').textContent = profile.role || 'موظف';
                detailsDiv.innerHTML = `
                    <div class="profile-item">
                        <div class="profile-label">الاسم:</div>
                        <div class="profile-value">${profile.full_name || 'غير محدد'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">البريد الإلكتروني:</div>
                        <div class="profile-value">${profile.email || 'غير محدد'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">الهاتف:</div>
                        <div class="profile-value">${profile.phone || 'غير محدد'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">الرقم الوطني:</div>
                        <div class="profile-value">${profile.national_id || 'غير محدد'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">تاريخ التوظيف:</div>
                        <div class="profile-value">${profile.hire_date || 'غير محدد'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">الحالة:</div>
                        <div class="profile-value">${profile.status || 'غير محدد'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">الدور:</div>
                        <div class="profile-value">${profile.role || 'غير محدد'}</div>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = '<p class="message error">لا يمكن تحميل معلومات الملف الشخصي.</p>';
            }
        }
        // تحميل معلومات الراتب
        async function loadSalaryInfo() {
            const salary = await fetchSalary(currentUser.id);
            const salaryDiv = document.getElementById('salaryInfo');
            if (salary) {
                salaryDiv.innerHTML = `
                    <div class="salary-item">
                        <div class="salary-label">الشهر:</div>
                        <div class="salary-value">${salary.month || 'غير محدد'}</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">الراتب الأساسي:</div>
                        <div class="salary-value">${salary.base_salary || 0} ج.م</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">الحوافز:</div>
                        <div class="salary-value">${salary.bonuses || 0} ج.م</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-label">الخصومات:</div>
                        <div class="salary-value">${salary.deductions || 0} ج.م</div>
                    </div>
                    <div class="salary-item total-salary">
                        <div class="salary-label">الراتب الصافي:</div>
                        <div class="salary-value">${salary.net_salary || 0} ج.م</div>
                    </div>
                `;
            } else {
                salaryDiv.innerHTML = '<p class="message error">لا توجد معلومات راتب متاحة حالياً.</p>';
            }
        }
        // تحميل سجل الحضور
        async function loadAttendanceList() {
            const attendanceRecords = await fetchAttendance(currentUser.id);
            const listDiv = document.getElementById('attendanceList');
            if (attendanceRecords && attendanceRecords.length > 0) {
                listDiv.innerHTML = '';
                attendanceRecords.forEach(record => {
                    const date = new Date(record.date);
                    // تنسيق التاريخ إلى ميلادي
                    const formattedDate = date.toLocaleDateString('en-US', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    const attendanceItem = document.createElement('div');
                    attendanceItem.className = 'attendance-item';
                    attendanceItem.innerHTML = `
                        <div class="attendance-date">${formattedDate}</div>
                        <div class="attendance-times">
                            <div class="time-item">
                                <span class="time-label">الحضور</span>
                                <span class="time-value">${record.check_in || 'لم يسجل'}</span>
                            </div>
                            <div class="time-item">
                                <span class="time-label">الانصراف</span>
                                <span class="time-value">${record.check_out || 'لم يسجل'}</span>
                            </div>
                        </div>
                        <div><span class="status-badge status-${record.status === 'present' ? 'present' : 'absent'}">${record.status === 'present' ? 'حاضر' : 'غائب'}</span></div>
                    `;
                    listDiv.appendChild(attendanceItem);
                });
            } else {
                listDiv.innerHTML = '<p class="message error">لا توجد سجلات حضور متاحة.</p>';
            }
        }
        // تحميل تقويم الحضور
        async function loadAttendanceCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            document.getElementById('currentMonth').textContent = 
                `${new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            const attendanceRecords = await fetchAttendanceForMonth(currentUser.id, year, month + 1);
            const calendarDates = document.getElementById('calendarDates');
            // Clear calendar
            calendarDates.innerHTML = '';
            // Get first day of month and last day of month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            // Add empty cells for days before the first day
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-date';
                calendarDates.appendChild(emptyCell);
            }
            // Add cells for each day of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const date = new Date(year, month, day);
                const dateCell = document.createElement('div');
                dateCell.className = 'calendar-date';
                dateCell.textContent = day;
                // Check if this date is today
                if (date.toDateString() === today.toDateString()) {
                    dateCell.classList.add('today');
                }
                // Check attendance status for this date
                const attendance = attendanceRecords.find(record => record.date === dateStr);
                if (attendance) {
                    if (attendance.status === 'present') {
                        dateCell.classList.add('present');
                    } else {
                        dateCell.classList.add('absent');
                    }
                }
                calendarDates.appendChild(dateCell);
            }
            // Calculate attendance stats
            const presentDays = attendanceRecords.filter(record => record.status === 'present').length;
            const absentDays = attendanceRecords.filter(record => record.status === 'absent').length;
            const lateDays = attendanceRecords.filter(record => {
                if (record.check_in) {
                    const checkInTime = new Date(`1970-01-01T${record.check_in}`);
                    const standardTime = new Date('1970-01-01T09:00:00');
                    return checkInTime > standardTime;
                }
                return false;
            }).length;
            document.getElementById('presentDays').textContent = presentDays;
            document.getElementById('absentDays').textContent = absentDays;
            document.getElementById('lateDays').textContent = lateDays;
        }
        // تحميل طلبات الإجازة
        async function loadLeaveRequests() {
            const leaves = await fetchLeaves(currentUser.id);
            const listDiv = document.getElementById('leaveRequests');
            if (leaves && leaves.length > 0) {
                listDiv.innerHTML = '';
                leaves.forEach(leave => {
                    const startDate = new Date(leave.start_date);
                    const endDate = new Date(leave.end_date);
                    // تنسيق التواريخ إلى ميلادي
                    const startStr = startDate.toLocaleDateString('en-US', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    const endStr = endDate.toLocaleDateString('en-US', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    const typeText = {
                        'annual': 'سنوية',
                        'sick': 'مرضية',
                        'emergency': 'طارئة',
                        'unpaid': 'بدون راتب'
                    }[leave.type] || leave.type;
                    const statusText = {
                        'pending': 'معلق',
                        'approved': 'مقبول',
                        'rejected': 'مرفوض'
                    }[leave.status] || leave.status;
                    const leaveItem = document.createElement('div');
                    leaveItem.className = 'leave-item';
                    // استخدام leave.reason || 'غير محدد' للتعامل مع الحقل المحتمل أن يكون غير موجود
                    leaveItem.innerHTML = `
                        <div class="leave-header">
                            <div class="leave-dates">من ${startStr} إلى ${endStr}</div>
                            <div class="leave-status status-${leave.status}">${statusText}</div>
                        </div>
                        <div class="leave-details">
                            <div>نوع الإجازة: ${typeText}</div>
                            <div>السبب: ${(leave.reason !== undefined) ? leave.reason : 'غير محدد'}</div>
                        </div>
                    `;
                    listDiv.appendChild(leaveItem);
                });
            } else {
                listDiv.innerHTML = '<p class="message error">لا توجد طلبات إجازة.</p>';
            }
        }
        // فحص حالة الحضور اليوم
        async function checkTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const record = await fetchAttendanceForDate(currentUser.id, today);
            if (record) {
                if (record.check_in) {
                    document.getElementById('checkInBtn').disabled = true;
                    document.getElementById('checkInTime').textContent = record.check_in;
                } else {
                    document.getElementById('checkInBtn').disabled = false;
                }
                if (record.check_out) {
                    document.getElementById('checkOutBtn').disabled = true;
                    document.getElementById('checkOutTime').textContent = record.check_out;
                } else if (record.check_in) {
                    document.getElementById('checkOutBtn').disabled = false;
                }
            } else {
                document.getElementById('checkInBtn').disabled = false;
            }
        }
        // معالجة أحداث الأزرار
        document.getElementById('checkInBtn').addEventListener('click', recordCheckIn);
        document.getElementById('checkOutBtn').addEventListener('click', recordCheckOut);
        document.getElementById('leaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const leaveData = {
                start_date: document.getElementById('leaveStart').value,
                end_date: document.getElementById('leaveEnd').value,
                type: document.getElementById('leaveType').value,
                // استخدام .value || undefined للسماح بقيمة undefined إذا لم يكن الحقل موجودًا
                reason: document.getElementById('leaveReason').value || undefined
            };
            await submitLeaveRequest(leaveData);
        });
        // Navigation for calendar
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            loadAttendanceCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            loadAttendanceCalendar();
        });
        // دالة تسجيل الخروج
        window.handleSignOut = async function() {
            try {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification('حدث خطأ أثناء تسجيل الخروج', 'error');
            }
        };
        // تهيئة التطبيق
        window.addEventListener('load', async () => {
            const session = await checkSession();
            if (!session) return;
            // تهيئة تواريخ نموذج الإجازة
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveStart').min = today;
            document.getElementById('leaveEnd').min = today;
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('leaveStart').value = nextWeek.toISOString().split('T')[0];
            const weekAfter = new Date();
            weekAfter.setDate(weekAfter.getDate() + 9);
            document.getElementById('leaveEnd').value = weekAfter.toISOString().split('T')[0];
            // تحميل جميع البيانات
            await loadUserProfile();
            await loadSalaryInfo();
            await loadAttendanceList();
            await loadLeaveRequests();
            await checkTodayAttendance();
            await loadAttendanceCalendar();
            await calculateExpectedSalary(); // تحميل توقع الراتب عند بدء التطبيق
            // تفعيل زر الإجازة
            document.getElementById('submitLeaveBtn').disabled = false;
        });
        // تحديث الوقت في الرأس
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            // تنسيق التاريخ إلى ميلادي
            const dateStr = now.toLocaleDateString('en-US', options);
            document.querySelector('.header h1').innerHTML = 
                `<i class="fas fa-user-tie"></i> بوابة الموظف - ${dateStr}`;
        }
        updateDateTime();
        setInterval(updateDateTime, 60000);
    </script>
</body>
</html>