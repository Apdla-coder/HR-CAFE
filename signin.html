<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل مؤسسة جديدة</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
    
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      color: #667eea;
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1rem;
    }

    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .step.active .step-circle {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }

    .step.completed .step-circle {
      background: #28a745;
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: #666;
    }

    .step.active .step-label {
      color: #667eea;
      font-weight: 600;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .form-group label .required {
      color: #dc3545;
      margin-right: 2px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .logo-upload {
      border: 2px dashed #e0e0e0;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logo-upload:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }

    .logo-upload input {
      display: none;
    }

    .logo-preview {
      margin-top: 15px;
    }

    .logo-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.3s;
    }

    .alert.show {
      display: block;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .plan-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .plan-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .plan-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .plan-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .plan-card h3 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .plan-card .price {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      margin: 15px 0;
    }

    .plan-card .features {
      list-style: none;
      padding: 0;
      text-align: right;
      font-size: 0.9rem;
      color: #666;
    }

    .plan-card .features li {
      padding: 5px 0;
    }

    .plan-card .features li::before {
      content: '✓';
      color: #28a745;
      margin-left: 8px;
      font-weight: bold;
    }

    .summary-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }

    .summary-item:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.1rem;
      color: #667eea;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .steps {
        flex-direction: column;
        gap: 20px;
      }

      .steps::before {
        display: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-building"></i> تسجيل مؤسسة جديدة</h1>
      <p>أكمل البيانات التالية لإنشاء حساب مؤسستك</p>
    </div>

    <!-- Steps Indicator -->
    <div class="steps">
      <div class="step active" data-step="1">
        <div class="step-circle">1</div>
        <div class="step-label">معلومات المؤسسة</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-circle">2</div>
        <div class="step-label">معلومات الاتصال</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-circle">3</div>
        <div class="step-label">الباقة والإعدادات</div>
      </div>
      <div class="step" data-step="4">
        <div class="step-circle">4</div>
        <div class="step-label">حساب المدير</div>
      </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertBox" class="alert"></div>

    <!-- Form -->
    <form id="registrationForm">
      
      <!-- Step 1: Organization Info -->
      <div class="form-section active" data-section="1">
        <h3 style="margin-bottom: 20px; color: #667eea;">
          <i class="fas fa-building"></i> معلومات المؤسسة الأساسية
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label><span class="required">*</span> اسم المؤسسة</label>
            <input type="text" id="orgName" required placeholder="شركة النور للتجارة">
          </div>

          <div class="form-group">
            <label><span class="required">*</span> كود المؤسسة (فريد)</label>
            <input type="text" id="orgCode" required placeholder="ALNOOR" pattern="[A-Za-z0-9_-]+" title="حروف وأرقام فقط">
          </div>
        </div>

        <div class="form-group">
          <label>وصف المؤسسة</label>
          <textarea id="orgDescription" placeholder="نبذة مختصرة عن نشاط المؤسسة..."></textarea>
        </div>

        <div class="form-group">
          <label>شعار المؤسسة</label>
          <div class="logo-upload" onclick="document.getElementById('logoInput').click()">
            <i class="fas fa-cloud-upload-alt fa-3x" style="color: #667eea; margin-bottom: 10px;"></i>
            <p>اضغط لرفع شعار المؤسسة</p>
            <p style="font-size: 0.875rem; color: #999;">PNG, JPG (بحد أقصى 2MB)</p>
            <input type="file" id="logoInput" accept="image/*">
          </div>
          <div class="logo-preview" id="logoPreview"></div>
        </div>
      </div>

      <!-- Step 2: Contact Info -->
      <div class="form-section" data-section="2">
        <h3 style="margin-bottom: 20px; color: #667eea;">
          <i class="fas fa-address-card"></i> معلومات الاتصال
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label><span class="required">*</span> البريد الإلكتروني</label>
            <input type="email" id="orgEmail" required placeholder="info@company.com">
          </div>

          <div class="form-group">
            <label><span class="required">*</span> رقم الهاتف</label>
            <input type="tel" id="orgPhone" required placeholder="+20 100 123 4567">
          </div>
        </div>

        <div class="form-group">
          <label>الموقع الإلكتروني</label>
          <input type="url" id="orgWebsite" placeholder="https://www.company.com">
        </div>

        <div class="form-group">
          <label><span class="required">*</span> العنوان</label>
          <textarea id="orgAddress" required placeholder="الشارع، المدينة، المحافظة"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>المدينة</label>
            <input type="text" id="orgCity" placeholder="القاهرة">
          </div>

          <div class="form-group">
            <label>الدولة</label>
            <select id="orgCountry">
              <option value="EG">مصر</option>
              <option value="SA">السعودية</option>
              <option value="AE">الإمارات</option>
              <option value="KW">الكويت</option>
              <option value="QA">قطر</option>
              <option value="BH">البحرين</option>
              <option value="OM">عمان</option>
              <option value="JO">الأردن</option>
              <option value="LB">لبنان</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 3: Plan & Settings -->
      <div class="form-section" data-section="3">
        <h3 style="margin-bottom: 20px; color: #667eea;">
          <i class="fas fa-box"></i> اختر الباقة المناسبة
        </h3>

        <div class="plan-cards">
          <div class="plan-card" data-plan="basic">
            <h3>الباقة الأساسية</h3>
            <div class="price">مجاناً</div>
            <ul class="features">
              <li>حتى 10 موظفين</li>
              <li>فرع واحد</li>
              <li>تقارير أساسية</li>
              <li>1 جيجا تخزين</li>
            </ul>
          </div>

          <div class="plan-card" data-plan="professional">
            <h3>الباقة الاحترافية</h3>
            <div class="price">499 ج.م <small>/شهرياً</small></div>
            <ul class="features">
              <li>حتى 50 موظف</li>
              <li>حتى 3 فروع</li>
              <li>تقارير متقدمة</li>
              <li>10 جيجا تخزين</li>
              <li>دعم فني</li>
            </ul>
          </div>

          <div class="plan-card" data-plan="enterprise">
            <h3>باقة الشركات</h3>
            <div class="price">1499 ج.م <small>/شهرياً</small></div>
            <ul class="features">
              <li>موظفين غير محدودين</li>
              <li>فروع غير محدودة</li>
              <li>كل الميزات</li>
              <li>50 جيجا تخزين</li>
              <li>دعم ذو أولوية</li>
              <li>API متقدم</li>
            </ul>
          </div>
        </div>

        <h3 style="margin: 30px 0 20px; color: #667eea;">
          <i class="fas fa-cog"></i> إعدادات المؤسسة
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label>العملة</label>
            <select id="orgCurrency">
              <option value="EGP">جنيه مصري (EGP)</option>
              <option value="SAR">ريال سعودي (SAR)</option>
              <option value="AED">درهم إماراتي (AED)</option>
              <option value="KWD">دينار كويتي (KWD)</option>
              <option value="USD">دولار أمريكي (USD)</option>
            </select>
          </div>

          <div class="form-group">
            <label>المنطقة الزمنية</label>
            <select id="orgTimezone">
              <option value="Africa/Cairo">القاهرة (GMT+2)</option>
              <option value="Asia/Riyadh">الرياض (GMT+3)</option>
              <option value="Asia/Dubai">دبي (GMT+4)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ساعات العمل اليومية</label>
            <input type="number" id="workHours" min="1" max="24" value="8">
          </div>

          <div class="form-group">
            <label>أيام العمل الأسبوعية</label>
            <input type="number" id="workDays" min="1" max="7" value="5">
          </div>
        </div>
      </div>

      <!-- Step 4: Admin Account -->
      <div class="form-section" data-section="4">
        <h3 style="margin-bottom: 20px; color: #667eea;">
          <i class="fas fa-user-shield"></i> حساب مدير المؤسسة
        </h3>

        <div class="form-row">
          <div class="form-group">
            <label><span class="required">*</span> الاسم الكامل</label>
            <input type="text" id="adminName" required placeholder="أحمد محمد">
          </div>

          <div class="form-group">
            <label><span class="required">*</span> البريد الإلكتروني</label>
            <input type="email" id="adminEmail" required placeholder="admin@company.com">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label><span class="required">*</span> كلمة المرور</label>
            <input type="password" id="adminPassword" required minlength="6" placeholder="6 أحرف على الأقل">
          </div>

          <div class="form-group">
            <label><span class="required">*</span> تأكيد كلمة المرور</label>
            <input type="password" id="adminPasswordConfirm" required minlength="6" placeholder="أعد إدخال كلمة المرور">
          </div>
        </div>

        <div class="form-group">
          <label>رقم الهاتف</label>
          <input type="tel" id="adminPhone" placeholder="+20 100 123 4567">
        </div>

        <div class="summary-box">
          <h4 style="margin-bottom: 15px;">ملخص التسجيل</h4>
          <div class="summary-item">
            <span>المؤسسة:</span>
            <span id="summaryOrgName">-</span>
          </div>
          <div class="summary-item">
            <span>الباقة:</span>
            <span id="summaryPlan">-</span>
          </div>
          <div class="summary-item">
            <span>المدير:</span>
            <span id="summaryAdmin">-</span>
          </div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="buttons">
        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
          <i class="fas fa-arrow-right"></i> السابق
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn">
          التالي <i class="fas fa-arrow-left"></i>
        </button>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
          <i class="fas fa-check"></i> إنشاء المؤسسة
        </button>
      </div>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://nxhnivykhlnauewpmuqv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54aG5pdnlraGxuYXVld3BtdXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4Mjk2NTYsImV4cCI6MjA3NDQwNTY1Nn0.-3ps3Mp7aYuA2m54sW3gNN3CpZ2acRtKGj8jI5eHTOU";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentStep = 1;
    let selectedPlan = 'basic';
    let logoFile = null;

    // Logo Upload Handler
    document.getElementById('logoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          showAlert('حجم الملف يجب ألا يتجاوز 2 ميجابايت', 'error');
          e.target.value = '';
          return;
        }
        logoFile = file;
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('logoPreview').innerHTML = 
            `<img src="${event.target.result}" alt="Logo Preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    // Plan Selection
    document.querySelectorAll('.plan-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedPlan = card.dataset.plan;
        updateSummary();
      });
    });

    // Select default plan
    document.querySelector('[data-plan="basic"]').classList.add('selected');

    // Navigation
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (validateStep(currentStep)) {
        if (currentStep < 4) {
          goToStep(currentStep + 1);
        }
      }
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentStep > 1) {
        goToStep(currentStep - 1);
      }
    });

    function goToStep(step) {
      // Update step indicator
      document.querySelectorAll('.step').forEach(s => {
        const stepNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (stepNum === step) {
          s.classList.add('active');
        } else if (stepNum < step) {
          s.classList.add('completed');
        }
      });

      // Update form sections
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelector(`[data-section="${step}"]`).classList.add('active');

      currentStep = step;

      // Update buttons
      document.getElementById('prevBtn').style.display = step > 1 ? 'flex' : 'none';
      document.getElementById('nextBtn').style.display = step < 4 ? 'flex' : 'none';
      document.getElementById('submitBtn').style.display = step === 4 ? 'flex' : 'none';

      // Update summary on last step
      if (step === 4) {
        updateSummary();
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
      const requiredFields = {
        1: ['orgName', 'orgCode'],
        2: ['orgEmail', 'orgPhone', 'orgAddress'],
        3: [],
        4: ['adminName', 'adminEmail', 'adminPassword', 'adminPasswordConfirm']
      };

      const fields = requiredFields[step];
      for (const fieldId of fields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          showAlert('يرجى إكمال جميع الحقول المطلوبة', 'error');
          field.focus();
          return false;
        }
      }

      // Validate org code format
      if (step === 1) {
        const orgCode = document.getElementById('orgCode').value;
        if (!/^[A-Za-z0-9_-]+$/.test(orgCode)) {
          showAlert('كود المؤسسة يجب أن يحتوي على حروف وأرقام فقط', 'error');
          return false;
        }
      }

      // Validate passwords match
      if (step === 4) {
        const password = document.getElementById('adminPassword').value;
        const confirm = document.getElementById('adminPasswordConfirm').value;
        if (password !== confirm) {
          showAlert('كلمة المرور وتأكيدها غير متطابقين', 'error');
          return false;
        }
      }

      return true;
    }

    function updateSummary() {
      document.getElementById('summaryOrgName').textContent = 
        document.getElementById('orgName').value || '-';
      
      const planNames = {
        basic: 'الباقة الأساسية (مجاناً)',
        professional: 'الباقة الاحترافية (499 ج.م/شهرياً)',
        enterprise: 'باقة الشركات (1499 ج.م/شهرياً)'
      };
      document.getElementById('summaryPlan').textContent = planNames[selectedPlan];
      
      document.getElementById('summaryAdmin').textContent = 
        document.getElementById('adminName').value || '-';
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.className = `alert alert-${type} show`;
      alertBox.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
      setTimeout(() => alertBox.classList.remove('show'), 5000);
    }

    // Form Submission
    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validateStep(4)) return;

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> جاري الإنشاء...';

      try {
        // 1. Upload logo if exists
        let logoUrl = null;
        if (logoFile) {
          const fileExt = logoFile.name.split('.').pop();
          const fileName = `${document.getElementById('orgCode').value}_${Date.now()}.${fileExt}`;
          const filePath = `organization_logos/${fileName}`;

          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('employee-files')
            .upload(filePath, logoFile);

          if (uploadError) throw uploadError;

          const { data: urlData } = supabase.storage
            .from('employee-files')
            .getPublicUrl(filePath);
          
          logoUrl = urlData.publicUrl;
        }

        // 2. Create admin user in auth
        const adminEmail = document.getElementById('adminEmail').value;
        const adminPassword = document.getElementById('adminPassword').value;
        const adminName = document.getElementById('adminName').value;

        const { data: authData, error: authError } = await supabase.auth.signUp({
          email: adminEmail,
          password: adminPassword,
          options: {
            data: {
              full_name: adminName,
              role: 'admin'
            }
          }
        });

        if (authError) throw authError;
        if (!authData.user) throw new Error('فشل إنشاء حساب المدير');

        const adminUserId = authData.user.id;

        // 3. Create organization
        const orgData = {
          name: document.getElementById('orgName').value,
          code: document.getElementById('orgCode').value.toUpperCase(),
          description: document.getElementById('orgDescription').value,
          email: document.getElementById('orgEmail').value,
          phone: document.getElementById('orgPhone').value,
          website: document.getElementById('orgWebsite').value,
          address: document.getElementById('orgAddress').value,
          city: document.getElementById('orgCity').value,
          country: document.getElementById('orgCountry').value,
          logo_url: logoUrl,
          plan: selectedPlan,
          currency: document.getElementById('orgCurrency').value,
          timezone: document.getElementById('orgTimezone').value,
          work_hours_per_day: parseInt(document.getElementById('workHours').value),
          work_days_per_week: parseInt(document.getElementById('workDays').value),
          status: 'active',
          created_at: new Date().toISOString()
        };

        const { data: org, error: orgError } = await supabase
          .from('organizations')
          .insert([orgData])
          .select()
          .single();

        if (orgError) throw orgError;

        // 4. Create main branch
        const branchData = {
          organization_id: org.id,
          name: 'الفرع الرئيسي',
          code: 'MAIN',
          address: document.getElementById('orgAddress').value,
          phone: document.getElementById('orgPhone').value,
          is_active: true,
          created_at: new Date().toISOString()
        };

        const { data: branch, error: branchError } = await supabase
          .from('branches')
          .insert([branchData])
          .select()
          .single();

        if (branchError) throw branchError;

        // 5. Create admin user record
        const userData = {
          id: adminUserId,
          full_name: adminName,
          email: adminEmail,
          phone: document.getElementById('adminPhone').value,
          role: 'admin',
          organization_id: org.id,
          primary_branch_id: branch.id,
          status: 'active',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        const { error: userError } = await supabase
          .from('users')
          .insert([userData]);

        if (userError) {
          // Try update if insert fails
          const { error: updateError } = await supabase
            .from('users')
            .update(userData)
            .eq('id', adminUserId);
          
          if (updateError) throw updateError;
        }

        // 6. Create user-branch relationship
        await supabase
          .from('user_branches')
          .insert([{
            user_id: adminUserId,
            branch_id: branch.id,
            is_primary: true
          }]);

        // Success!
        showAlert('تم إنشاء المؤسسة بنجاح! جاري تحويلك...', 'success');
        
        setTimeout(() => {
          window.location.href = 'admin-dashboard.html';
        }, 2000);

      } catch (error) {
        console.error('Registration error:', error);
        let errorMessage = 'حدث خطأ أثناء إنشاء المؤسسة';
        
        if (error.message.includes('duplicate') || error.message.includes('already exists')) {
          if (error.message.includes('code')) {
            errorMessage = 'كود المؤسسة مستخدم بالفعل، يرجى اختيار كود آخر';
          } else if (error.message.includes('email')) {
            errorMessage = 'البريد الإلكتروني مسجل بالفعل';
          }
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showAlert(errorMessage, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> إنشاء المؤسسة';
      }
    });

    // Auto-generate org code from name
    document.getElementById('orgName').addEventListener('input', (e) => {
      const name = e.target.value;
      const code = name
        .replace(/[^a-zA-Z0-9\s]/g, '')
        .split(' ')
        .map(word => word.substring(0, 3))
        .join('')
        .toUpperCase()
        .substring(0, 10);
      
      if (code && !document.getElementById('orgCode').value) {
        document.getElementById('orgCode').value = code;
      }
    });
  </script>
</body>
</html>